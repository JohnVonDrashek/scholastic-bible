---
// Web Speech API narration component for chapter pages
---

<div class="narration-controls">
  <button id="narration-btn" class="narration-btn" title="Listen to chapter">
    <svg class="icon-play" viewBox="0 0 24 24" width="20" height="20">
      <path fill="currentColor" d="M8 5v14l11-7z"/>
    </svg>
    <svg class="icon-pause" viewBox="0 0 24 24" width="20" height="20" style="display:none">
      <path fill="currentColor" d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
    </svg>
    <span class="narration-label">Listen</span>
  </button>
  <button id="narration-stop" class="narration-stop" title="Stop" style="display:none">
    <svg viewBox="0 0 24 24" width="16" height="16">
      <path fill="currentColor" d="M6 6h12v12H6z"/>
    </svg>
  </button>

  <div class="verse-progress">
    <select id="verse-select" class="verse-num-select" title="Start from verse">
      <option value="0">1</option>
    </select>
    <span class="verse-total">/ <span id="verse-total">1</span></span>
  </div>

  <div class="voice-selector">
    <label for="voice-select" class="voice-label">Voice:</label>
    <select id="voice-select" class="voice-select">
      <option value="">Loading voices...</option>
    </select>
  </div>

  <label class="scroll-toggle" title="Auto-scroll to current verse">
    <input type="checkbox" id="auto-scroll" checked />
    <span class="scroll-label">Scroll</span>
  </label>

  <select id="speed-select" class="speed-select" title="Playback speed">
    <option value="0.5">0.5x</option>
    <option value="0.75">0.75x</option>
    <option value="0.9" selected>0.9x</option>
    <option value="1">1x</option>
    <option value="1.25">1.25x</option>
    <option value="1.5">1.5x</option>
    <option value="2">2x</option>
  </select>
</div>

<script>
  const btn = document.getElementById('narration-btn') as HTMLButtonElement;
  const stopBtn = document.getElementById('narration-stop') as HTMLButtonElement;
  const voiceSelect = document.getElementById('voice-select') as HTMLSelectElement;
  const verseSelect = document.getElementById('verse-select') as HTMLSelectElement;
  const verseTotal = document.getElementById('verse-total') as HTMLSpanElement;
  const autoScrollCheckbox = document.getElementById('auto-scroll') as HTMLInputElement;
  const speedSelect = document.getElementById('speed-select') as HTMLSelectElement;
  const iconPlay = btn?.querySelector('.icon-play') as SVGElement;
  const iconPause = btn?.querySelector('.icon-pause') as SVGElement;
  const label = btn?.querySelector('.narration-label') as HTMLSpanElement;

  let utterance: SpeechSynthesisUtterance | null = null;
  let verses: { number: string; text: string; element: Element }[] = [];
  let currentIndex = 0;
  let isPlaying = false;
  let isPaused = false;
  let availableVoices: SpeechSynthesisVoice[] = [];
  let selectedVoice: SpeechSynthesisVoice | null = null;

  const STORAGE_KEY = 'scholastic-bible-voice';
  const SCROLL_STORAGE_KEY = 'scholastic-bible-autoscroll';
  const SPEED_STORAGE_KEY = 'scholastic-bible-speed';

  // Load speed preference
  const savedSpeed = localStorage.getItem(SPEED_STORAGE_KEY);
  if (savedSpeed && speedSelect) {
    speedSelect.value = savedSpeed;
  }

  // Save speed preference on change
  speedSelect?.addEventListener('change', () => {
    localStorage.setItem(SPEED_STORAGE_KEY, speedSelect.value);
    // If playing, restart current verse with new speed
    if (isPlaying && !isPaused) {
      speechSynthesis.cancel();
      speakVerse(currentIndex);
    }
  });

  // Load auto-scroll preference
  const savedScroll = localStorage.getItem(SCROLL_STORAGE_KEY);
  if (savedScroll !== null && autoScrollCheckbox) {
    autoScrollCheckbox.checked = savedScroll === 'true';
  }

  // Save auto-scroll preference on change
  autoScrollCheckbox?.addEventListener('change', () => {
    localStorage.setItem(SCROLL_STORAGE_KEY, String(autoScrollCheckbox.checked));
  });

  // Score voices to find best defaults
  function scoreVoice(voice: SpeechSynthesisVoice): number {
    let score = 0;
    const name = voice.name.toLowerCase();
    const lang = voice.lang.toLowerCase();

    // Must be English
    if (!lang.startsWith('en')) return -1000;

    // Prefer US/UK English
    if (lang === 'en-us' || lang === 'en-gb') score += 10;

    // Google voices are high quality (Chrome)
    if (name.includes('google')) score += 50;

    // Google UK English Male is particularly good for scripture reading
    if (name.includes('google uk english male')) score += 30;

    // Enhanced/Premium voices (macOS)
    if (name.includes('enhanced') || name.includes('premium')) score += 40;

    // Specific high-quality voices
    if (name.includes('daniel')) score += 35; // Best for scripture on macOS
    if (name.includes('samantha')) score += 25;
    if (name.includes('karen')) score += 25;
    if (name.includes('moira')) score += 25;

    // Microsoft natural voices
    if (name.includes('natural')) score += 35;

    // Avoid compact/small voices
    if (name.includes('compact')) score -= 20;

    // Prefer non-local voices (often higher quality)
    if (!voice.localService) score += 15;

    return score;
  }

  // Populate voice dropdown
  function populateVoices() {
    availableVoices = speechSynthesis.getVoices();

    // Filter to English voices and sort by quality score
    const englishVoices = availableVoices
      .filter(v => v.lang.toLowerCase().startsWith('en'))
      .map(v => ({ voice: v, score: scoreVoice(v) }))
      .sort((a, b) => b.score - a.score);

    if (englishVoices.length === 0) {
      voiceSelect.innerHTML = '<option value="">No English voices found</option>';
      return;
    }

    // Build options with quality indicators
    voiceSelect.innerHTML = englishVoices.map(({ voice, score }) => {
      const quality = score >= 40 ? ' *' : '';
      const local = voice.localService ? '' : ' (network)';
      return `<option value="${voice.name}">${voice.name}${quality}${local}</option>`;
    }).join('');

    // Restore saved preference or use best default
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved && englishVoices.some(v => v.voice.name === saved)) {
      voiceSelect.value = saved;
      selectedVoice = availableVoices.find(v => v.name === saved) || null;
    } else {
      // Use highest scored voice
      voiceSelect.value = englishVoices[0].voice.name;
      selectedVoice = englishVoices[0].voice;
    }
  }

  // Handle voice change
  voiceSelect?.addEventListener('change', () => {
    const name = voiceSelect.value;
    selectedVoice = availableVoices.find(v => v.name === name) || null;
    localStorage.setItem(STORAGE_KEY, name);

    // If currently playing, restart current verse with new voice
    if (isPlaying && !isPaused) {
      speechSynthesis.cancel();
      speakVerse(currentIndex);
    }
  });

  // Load voices (may be async in some browsers)
  populateVoices();
  if (speechSynthesis.onvoiceschanged !== undefined) {
    speechSynthesis.onvoiceschanged = populateVoices;
  }

  // Gather all verses on the page and populate verse selector
  function gatherVerses() {
    // Save current selection before repopulating
    const savedSelection = verseSelect?.value;

    verses = [];
    document.querySelectorAll('.verse').forEach((el) => {
      const numEl = el.querySelector('.verse-number');
      const textEl = el.querySelector('.verse-text');
      if (numEl && textEl) {
        verses.push({
          number: numEl.textContent || '',
          text: textEl.textContent || '',
          element: el
        });
      }
    });

    // Populate verse selector
    if (verseSelect && verses.length > 0) {
      verseSelect.innerHTML = verses.map((v, i) =>
        `<option value="${i}">${v.number}</option>`
      ).join('');

      // Restore selection
      if (savedSelection !== undefined) {
        verseSelect.value = savedSelection;
      }
    }

    // Update total count
    if (verseTotal) {
      verseTotal.textContent = String(verses.length);
    }
  }

  // Populate verses on load
  gatherVerses();

  // Handle verse selection change
  verseSelect?.addEventListener('change', () => {
    const newIndex = parseInt(verseSelect.value, 10);
    if (!isNaN(newIndex)) {
      currentIndex = newIndex;
      // If playing, restart from new verse
      if (isPlaying && !isPaused) {
        speechSynthesis.cancel();
        speakVerse(currentIndex);
      }
    }
  });

  // Highlight current verse
  function highlightVerse(index: number) {
    document.querySelectorAll('.verse.reading').forEach(el => el.classList.remove('reading'));
    if (verses[index]) {
      verses[index].element.classList.add('reading');
      // Only scroll if auto-scroll is enabled
      if (autoScrollCheckbox?.checked) {
        verses[index].element.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
  }

  // Update UI state
  function updateUI() {
    if (isPlaying && !isPaused) {
      iconPlay.style.display = 'none';
      iconPause.style.display = 'block';
      label.textContent = 'Pause';
      stopBtn.style.display = 'flex';
    } else if (isPaused) {
      iconPlay.style.display = 'block';
      iconPause.style.display = 'none';
      label.textContent = 'Resume';
      stopBtn.style.display = 'flex';
    } else {
      iconPlay.style.display = 'block';
      iconPause.style.display = 'none';
      label.textContent = 'Listen';
      stopBtn.style.display = 'none';
    }
  }

  // Speak a single verse
  function speakVerse(index: number) {
    if (index >= verses.length) {
      // Finished all verses
      stop();
      return;
    }

    currentIndex = index;
    const verse = verses[index];

    // Update verse selector to show current verse
    if (verseSelect) {
      verseSelect.value = String(index);
    }

    highlightVerse(index);

    utterance = new SpeechSynthesisUtterance(verse.text);
    utterance.rate = speedSelect ? parseFloat(speedSelect.value) : 0.9;
    utterance.pitch = 1;

    // Apply selected voice
    if (selectedVoice) {
      utterance.voice = selectedVoice;
    }

    utterance.onend = () => {
      if (isPlaying && !isPaused) {
        speakVerse(index + 1);
      }
    };

    utterance.onerror = (e) => {
      if (e.error !== 'interrupted') {
        console.error('Speech error:', e);
      }
    };

    speechSynthesis.speak(utterance);
  }

  // Start/resume playback
  function play() {
    if (isPaused) {
      speechSynthesis.resume();
      isPaused = false;
      isPlaying = true;
    } else {
      gatherVerses();
      if (verses.length === 0) return;
      // Start from selected verse
      const startIndex = verseSelect ? parseInt(verseSelect.value, 10) : 0;
      currentIndex = isNaN(startIndex) ? 0 : startIndex;
      isPlaying = true;
      isPaused = false;
      speakVerse(currentIndex);
    }
    updateUI();
  }

  // Pause playback
  function pause() {
    speechSynthesis.pause();
    isPaused = true;
    updateUI();
  }

  // Stop playback
  function stop() {
    speechSynthesis.cancel();
    isPlaying = false;
    isPaused = false;
    currentIndex = 0;
    document.querySelectorAll('.verse.reading').forEach(el => el.classList.remove('reading'));
    // Reset verse selector to first verse
    if (verseSelect) {
      verseSelect.value = '0';
    }
    updateUI();
  }

  // Button handlers
  btn?.addEventListener('click', () => {
    if (isPlaying && !isPaused) {
      pause();
    } else {
      play();
    }
  });

  stopBtn?.addEventListener('click', stop);

  // Clean up on page navigation
  document.addEventListener('astro:before-preparation', stop);
</script>

<style>
  .narration-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    padding: 0.75rem 1rem;
    background: var(--color-patched);
    border-radius: 6px;
    border: 1px solid var(--color-border);
    flex-wrap: wrap;
  }

  .narration-btn {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 1rem;
    background: var(--color-accent);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-family: var(--font-sans);
    font-size: 0.9rem;
    transition: background 0.15s ease;
  }

  .narration-btn:hover {
    background: #8B2500;
  }

  .narration-stop {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: var(--color-muted);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.15s ease;
  }

  .narration-stop:hover {
    background: #333;
  }

  .verse-progress {
    display: flex;
    align-items: center;
    gap: 0.2rem;
    margin-left: 0.75rem;
    font-family: var(--font-sans);
    font-size: 0.9rem;
    color: var(--color-muted);
  }

  .verse-num-select {
    font-family: var(--font-sans);
    font-size: 0.9rem;
    font-weight: 600;
    padding: 0.15rem 0.3rem;
    border: 1px solid var(--color-border);
    border-radius: 3px;
    background: white;
    color: var(--color-text);
    min-width: 40px;
    text-align: center;
    cursor: pointer;
    appearance: none;
    -webkit-appearance: none;
  }

  .verse-num-select:hover {
    border-color: var(--color-accent);
  }

  .verse-num-select:focus {
    outline: none;
    border-color: var(--color-accent);
  }

  .verse-total {
    color: var(--color-muted);
  }

  .scroll-toggle {
    display: flex;
    align-items: center;
    gap: 0.3rem;
    cursor: pointer;
    font-family: var(--font-sans);
    font-size: 0.8rem;
    color: var(--color-muted);
    margin-left: 0.5rem;
  }

  .scroll-toggle input {
    cursor: pointer;
    accent-color: var(--color-accent);
  }

  .scroll-label {
    user-select: none;
  }

  .speed-select {
    font-family: var(--font-sans);
    font-size: 0.8rem;
    padding: 0.2rem 0.4rem;
    border: 1px solid var(--color-border);
    border-radius: 3px;
    background: white;
    color: var(--color-text);
    cursor: pointer;
    margin-left: 0.5rem;
  }

  .speed-select:hover {
    border-color: var(--color-accent);
  }

  .speed-select:focus {
    outline: none;
    border-color: var(--color-accent);
  }

  .voice-selector {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    margin-left: auto;
  }

  .voice-label {
    font-family: var(--font-sans);
    font-size: 0.8rem;
    color: var(--color-muted);
  }

  .voice-select {
    font-family: var(--font-sans);
    font-size: 0.8rem;
    padding: 0.3rem 0.5rem;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    background: white;
    color: var(--color-text);
    max-width: 200px;
    cursor: pointer;
  }

  .voice-select:focus {
    outline: none;
    border-color: var(--color-accent);
  }

  /* Highlight currently reading verse */
  :global(.verse.reading) {
    background: #fff3cd !important;
    border-left: 3px solid var(--color-accent);
    padding-left: calc(0.5rem - 3px);
    margin-left: -0.5rem;
    padding-right: 0.5rem;
    margin-right: -0.5rem;
    border-radius: 3px;
  }

  @media (max-width: 600px) {
    .narration-controls {
      flex-wrap: wrap;
    }

    .voice-selector {
      width: 100%;
      margin-left: 0;
      margin-top: 0.5rem;
    }

    .voice-select {
      flex: 1;
      max-width: none;
    }
  }
</style>
