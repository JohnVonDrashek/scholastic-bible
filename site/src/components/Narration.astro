---
// Audio narration component for chapter pages
// Supports pre-recorded audio (primary) or Web Speech API TTS (fallback)

interface VerseTiming {
  verse: number;
  start: number;
  end: number;
}

interface Props {
  audioSrc?: string; // Path to pre-recorded MP3, e.g., "/audio/genesis/1.mp3"
  timingData?: VerseTiming[]; // Verse timing data for auto-scroll
}

const { audioSrc, timingData } = Astro.props;
const hasAudio = !!audioSrc;
const hasTimingData = timingData && timingData.length > 0;
---

<div
  class="narration-bar"
  data-mode={hasAudio ? 'audio' : 'tts'}
  data-audio-src={audioSrc || ''}
  data-timing={hasTimingData ? JSON.stringify(timingData) : ''}
>
  <div class="narration-header">
    <svg class="narration-icon" viewBox="0 0 24 24" width="18" height="18">
      <path fill="currentColor" d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
    </svg>
    <span class="narration-title">Listen to Chapter</span>
    <span class="narration-mode">{hasAudio ? 'LibriVox Recording' : 'Browser TTS'}</span>
  </div>

  {hasAudio ? (
    <!-- Pre-recorded audio mode -->
    <div class="narration-controls audio-mode">
      <div class="playback-controls">
        <button id="narration-btn" class="narration-btn" title="Play/Pause">
          <svg class="icon-play" viewBox="0 0 24 24" width="22" height="22">
            <path fill="currentColor" d="M8 5v14l11-7z"/>
          </svg>
          <svg class="icon-pause" viewBox="0 0 24 24" width="22" height="22" style="display:none">
            <path fill="currentColor" d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
          </svg>
        </button>
        <button id="narration-stop" class="narration-stop" title="Stop" style="display:none">
          <svg viewBox="0 0 24 24" width="16" height="16">
            <path fill="currentColor" d="M6 6h12v12H6z"/>
          </svg>
        </button>
        <span id="narration-status" class="narration-status">Ready</span>
      </div>

      <div class="narration-divider"></div>

      <div class="progress-container">
        <span id="time-current" class="time-display">0:00</span>
        <input type="range" id="progress-bar" class="progress-bar" min="0" max="100" value="0" />
        <span id="time-total" class="time-display">0:00</span>
      </div>

      <div class="narration-divider"></div>

      <div class="speed-selector">
        <span class="control-label">Speed</span>
        <select id="speed-select" class="speed-select" title="Playback speed">
          <option value="0.5">0.5x</option>
          <option value="0.75">0.75x</option>
          <option value="1" selected>1x</option>
          <option value="1.25">1.25x</option>
          <option value="1.5">1.5x</option>
          <option value="2">2x</option>
        </select>
      </div>

      {hasTimingData && (
        <label class="scroll-toggle" title="Auto-scroll to current verse">
          <input type="checkbox" id="auto-scroll" checked />
          <svg class="scroll-icon" viewBox="0 0 24 24" width="16" height="16">
            <path fill="currentColor" d="M12 5.83L15.17 9l1.41-1.41L12 3 7.41 7.59 8.83 9 12 5.83zm0 12.34L8.83 15l-1.41 1.41L12 21l4.59-4.59L15.17 15 12 18.17z"/>
          </svg>
          <span class="scroll-label">Follow</span>
        </label>
      )}
    </div>

    <!-- Hidden audio element -->
    <audio id="audio-player" preload="metadata">
      <source src={audioSrc} type="audio/mpeg" />
    </audio>
  ) : (
    <!-- TTS fallback mode -->
    <div class="narration-controls tts-mode">
      <div class="playback-controls">
        <button id="narration-btn" class="narration-btn" title="Listen to chapter">
          <svg class="icon-play" viewBox="0 0 24 24" width="22" height="22">
            <path fill="currentColor" d="M8 5v14l11-7z"/>
          </svg>
          <svg class="icon-pause" viewBox="0 0 24 24" width="22" height="22" style="display:none">
            <path fill="currentColor" d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
          </svg>
        </button>
        <button id="narration-stop" class="narration-stop" title="Stop" style="display:none">
          <svg viewBox="0 0 24 24" width="16" height="16">
            <path fill="currentColor" d="M6 6h12v12H6z"/>
          </svg>
        </button>
        <span id="narration-status" class="narration-status">Ready</span>
      </div>

      <div class="narration-divider"></div>

      <div class="verse-selector">
        <span class="control-label">Verse</span>
        <div class="verse-progress">
          <input type="number" id="verse-input" class="verse-num-input" min="1" max="1" value="1" title="Start from verse" />
          <span class="verse-total">of <span id="verse-total">1</span></span>
        </div>
      </div>

      <div class="narration-divider"></div>

      <div class="speed-selector">
        <span class="control-label">Speed</span>
        <select id="speed-select" class="speed-select" title="Playback speed">
          <option value="0.5">0.5x</option>
          <option value="0.75">0.75x</option>
          <option value="0.9" selected>0.9x</option>
          <option value="1">1x</option>
          <option value="1.25">1.25x</option>
          <option value="1.5">1.5x</option>
          <option value="2">2x</option>
        </select>
      </div>

      <label class="scroll-toggle" title="Auto-scroll to current verse">
        <input type="checkbox" id="auto-scroll" checked />
        <svg class="scroll-icon" viewBox="0 0 24 24" width="16" height="16">
          <path fill="currentColor" d="M12 5.83L15.17 9l1.41-1.41L12 3 7.41 7.59 8.83 9 12 5.83zm0 12.34L8.83 15l-1.41 1.41L12 21l4.59-4.59L15.17 15 12 18.17z"/>
        </svg>
        <span class="scroll-label">Auto-scroll</span>
      </label>
    </div>

    <div class="voice-row">
      <svg class="voice-icon" viewBox="0 0 24 24" width="14" height="14">
        <path fill="currentColor" d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>
      </svg>
      <label for="voice-select" class="voice-label">Voice:</label>
      <select id="voice-select" class="voice-select">
        <option value="">Loading voices...</option>
      </select>
    </div>
  )}
</div>

<script>
  function setupNarration() {
    const narrationBar = document.querySelector('.narration-bar') as HTMLElement;
    if (!narrationBar) return;

    const mode = narrationBar.dataset.mode;

    if (mode === 'audio') {
      setupAudioMode();
    } else {
      setupTTSMode();
    }
  }

  /**
   * Pre-recorded audio mode
   */
  function setupAudioMode() {
    const narrationBar = document.querySelector('.narration-bar') as HTMLElement;
    const audio = document.getElementById('audio-player') as HTMLAudioElement;
    const btn = document.getElementById('narration-btn') as HTMLButtonElement;
    const stopBtn = document.getElementById('narration-stop') as HTMLButtonElement;
    const progressBar = document.getElementById('progress-bar') as HTMLInputElement;
    const timeCurrent = document.getElementById('time-current') as HTMLSpanElement;
    const timeTotal = document.getElementById('time-total') as HTMLSpanElement;
    const speedSelect = document.getElementById('speed-select') as HTMLSelectElement;
    const statusEl = document.getElementById('narration-status') as HTMLSpanElement;
    const autoScrollCheckbox = document.getElementById('auto-scroll') as HTMLInputElement;

    if (!audio || !btn) return;

    const iconPlay = btn.querySelector('.icon-play') as SVGElement;
    const iconPause = btn.querySelector('.icon-pause') as SVGElement;

    const SPEED_STORAGE_KEY = 'scholastic-bible-audio-speed';
    const SCROLL_STORAGE_KEY = 'scholastic-bible-autoscroll';

    // Parse timing data
    interface VerseTiming { verse: number; start: number; end: number; }
    let timingData: VerseTiming[] = [];
    try {
      const timingStr = narrationBar?.dataset.timing;
      if (timingStr) {
        timingData = JSON.parse(timingStr);
      }
    } catch (e) {
      console.warn('Failed to parse timing data:', e);
    }

    let currentVerseIndex = -1;

    // Load auto-scroll preference
    if (autoScrollCheckbox) {
      const savedScroll = localStorage.getItem(SCROLL_STORAGE_KEY);
      if (savedScroll !== null) {
        autoScrollCheckbox.checked = savedScroll === 'true';
      }
      autoScrollCheckbox.addEventListener('change', () => {
        localStorage.setItem(SCROLL_STORAGE_KEY, String(autoScrollCheckbox.checked));
      });
    }

    // Find verse element by number
    function getVerseElement(verseNum: number): Element | null {
      // Try to find verse by data attribute or verse number
      const verseEls = document.querySelectorAll('.verse');
      for (const el of verseEls) {
        const numEl = el.querySelector('.verse-number');
        const dropCap = el.querySelector('.drop-cap');
        if (numEl && numEl.textContent?.trim() === String(verseNum)) {
          return el;
        }
        // Verse 1 often has drop cap instead of number
        if (verseNum === 1 && dropCap && !numEl) {
          return el;
        }
      }
      return null;
    }

    // Smooth scroll with easing
    function smoothScrollTo(element: Element, duration: number = 600) {
      const targetRect = element.getBoundingClientRect();
      const targetY = targetRect.top + window.scrollY - (window.innerHeight / 2) + (targetRect.height / 2);
      const startY = window.scrollY;
      const distance = targetY - startY;
      const startTime = performance.now();

      // Ease-out cubic for smooth deceleration
      function easeOutCubic(t: number): number {
        return 1 - Math.pow(1 - t, 3);
      }

      function scroll(currentTime: number) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const eased = easeOutCubic(progress);

        window.scrollTo(0, startY + distance * eased);

        if (progress < 1) {
          requestAnimationFrame(scroll);
        }
      }

      requestAnimationFrame(scroll);
    }

    // Highlight and scroll to verse
    function highlightVerse(verseNum: number) {
      // Move current reading to was-reading for fade-out effect
      document.querySelectorAll('.verse.reading').forEach(el => {
        el.classList.remove('reading');
        el.classList.add('was-reading');
        // Remove was-reading after transition completes
        setTimeout(() => el.classList.remove('was-reading'), 400);
      });

      // Remove any lingering was-reading classes
      document.querySelectorAll('.verse.was-reading').forEach(el => {
        el.classList.remove('was-reading');
      });

      const verseEl = getVerseElement(verseNum);
      if (verseEl) {
        verseEl.classList.add('reading');
        if (autoScrollCheckbox?.checked) {
          smoothScrollTo(verseEl, 600);
        }
      }
    }

    // Find current verse based on audio time
    function updateCurrentVerse(currentTime: number) {
      if (timingData.length === 0) return;

      // Find the verse that contains the current time
      for (let i = 0; i < timingData.length; i++) {
        const timing = timingData[i];
        if (currentTime >= timing.start && currentTime < timing.end) {
          if (i !== currentVerseIndex) {
            currentVerseIndex = i;
            highlightVerse(timing.verse);
          }
          return;
        }
      }

      // Check if we're past the last verse
      const lastTiming = timingData[timingData.length - 1];
      if (currentTime >= lastTiming.end) {
        if (currentVerseIndex !== timingData.length - 1) {
          currentVerseIndex = timingData.length - 1;
          highlightVerse(lastTiming.verse);
        }
      }
    }

    // Clear verse highlighting
    function clearHighlighting() {
      currentVerseIndex = -1;
      document.querySelectorAll('.verse.reading').forEach(el => el.classList.remove('reading'));
    }

    // Load speed preference
    const savedSpeed = localStorage.getItem(SPEED_STORAGE_KEY);
    if (savedSpeed && speedSelect) {
      speedSelect.value = savedSpeed;
      audio.playbackRate = parseFloat(savedSpeed);
    }

    // Format time as M:SS
    function formatTime(seconds: number): string {
      if (isNaN(seconds)) return '0:00';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Update UI state
    function updateUI() {
      if (!audio.paused) {
        iconPlay.style.display = 'none';
        iconPause.style.display = 'block';
        statusEl.textContent = 'Playing';
        stopBtn.style.display = 'flex';
      } else if (audio.currentTime > 0) {
        iconPlay.style.display = 'block';
        iconPause.style.display = 'none';
        statusEl.textContent = 'Paused';
        stopBtn.style.display = 'flex';
      } else {
        iconPlay.style.display = 'block';
        iconPause.style.display = 'none';
        statusEl.textContent = 'Ready';
        stopBtn.style.display = 'none';
      }
    }

    // Update duration display when available
    function updateDuration() {
      const duration = audio.duration;
      if (duration && isFinite(duration) && duration > 0) {
        timeTotal.textContent = formatTime(duration);
        progressBar.max = String(Math.floor(duration));
      }
    }

    // Audio events - try multiple events since MP3 metadata can be tricky
    audio.addEventListener('loadedmetadata', updateDuration);
    audio.addEventListener('durationchange', updateDuration);
    audio.addEventListener('canplay', updateDuration);

    // Also check immediately in case already loaded
    if (audio.readyState >= 1) {
      updateDuration();
    }

    audio.addEventListener('timeupdate', () => {
      timeCurrent.textContent = formatTime(audio.currentTime);
      progressBar.value = String(Math.floor(audio.currentTime));
      // Update verse highlighting based on current time
      if (timingData.length > 0 && !audio.paused) {
        updateCurrentVerse(audio.currentTime);
      }
    });

    audio.addEventListener('play', updateUI);
    audio.addEventListener('pause', updateUI);

    // Clone buttons to remove old event listeners
    const newBtn = btn.cloneNode(true) as HTMLButtonElement;
    btn.parentNode?.replaceChild(newBtn, btn);
    const newStopBtn = stopBtn.cloneNode(true) as HTMLButtonElement;
    stopBtn.parentNode?.replaceChild(newStopBtn, stopBtn);

    // Get new references
    const activeIconPlay = newBtn.querySelector('.icon-play') as SVGElement;
    const activeIconPause = newBtn.querySelector('.icon-pause') as SVGElement;

    function updateUIActive() {
      const activeStatusEl = document.getElementById('narration-status') as HTMLSpanElement;
      if (!audio.paused) {
        activeIconPlay.style.display = 'none';
        activeIconPause.style.display = 'block';
        if (activeStatusEl) activeStatusEl.textContent = 'Playing';
        newStopBtn.style.display = 'flex';
      } else if (audio.currentTime > 0) {
        activeIconPlay.style.display = 'block';
        activeIconPause.style.display = 'none';
        if (activeStatusEl) activeStatusEl.textContent = 'Paused';
        newStopBtn.style.display = 'flex';
      } else {
        activeIconPlay.style.display = 'block';
        activeIconPause.style.display = 'none';
        if (activeStatusEl) activeStatusEl.textContent = 'Ready';
        newStopBtn.style.display = 'none';
      }
    }

    // Play/Pause button
    newBtn.addEventListener('click', () => {
      if (audio.paused) {
        audio.play();
      } else {
        audio.pause();
      }
      updateUIActive();
    });

    // Stop button
    newStopBtn.addEventListener('click', () => {
      audio.pause();
      audio.currentTime = 0;
      clearHighlighting();
      updateUIActive();
    });

    // Progress bar seeking
    progressBar.addEventListener('input', () => {
      audio.currentTime = parseFloat(progressBar.value);
    });

    // Speed control
    speedSelect?.addEventListener('change', () => {
      audio.playbackRate = parseFloat(speedSelect.value);
      localStorage.setItem(SPEED_STORAGE_KEY, speedSelect.value);
    });

    // When audio finishes, reset to ready state
    audio.addEventListener('ended', () => {
      audio.currentTime = 0;
      clearHighlighting();
      updateUIActive();
    });

    // Clean up on page navigation
    document.addEventListener('astro:before-preparation', () => {
      audio.pause();
      audio.currentTime = 0;
      clearHighlighting();
    });

    // Force reload audio to ensure metadata is loaded (helps with View Transitions)
    audio.load();

    // Global spacebar handler for play/pause
    function handleKeydown(e: KeyboardEvent) {
      // Only handle spacebar
      if (e.code !== 'Space') return;

      // Don't interfere with input fields
      const target = e.target as HTMLElement;
      if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.tagName === 'SELECT') {
        return;
      }

      // Prevent default scroll behavior
      e.preventDefault();

      // Toggle play/pause
      if (audio.paused) {
        audio.play();
      } else {
        audio.pause();
      }
      updateUIActive();
    }

    // Add listener
    document.addEventListener('keydown', handleKeydown);

    // Clean up listener on navigation
    document.addEventListener('astro:before-preparation', () => {
      document.removeEventListener('keydown', handleKeydown);
    }, { once: true });
  }

  /**
   * TTS fallback mode (existing implementation)
   */
  function setupTTSMode() {
    const btn = document.getElementById('narration-btn') as HTMLButtonElement;
    const stopBtn = document.getElementById('narration-stop') as HTMLButtonElement;
    const voiceSelect = document.getElementById('voice-select') as HTMLSelectElement;
    const verseInput = document.getElementById('verse-input') as HTMLInputElement;
    const verseTotal = document.getElementById('verse-total') as HTMLSpanElement;
    const autoScrollCheckbox = document.getElementById('auto-scroll') as HTMLInputElement;
    const speedSelect = document.getElementById('speed-select') as HTMLSelectElement;

    if (!btn) return;

    const iconPlay = btn.querySelector('.icon-play') as SVGElement;
    const iconPause = btn.querySelector('.icon-pause') as SVGElement;
    const statusEl = document.getElementById('narration-status') as HTMLSpanElement;

    let utterance: SpeechSynthesisUtterance | null = null;
    let verses: { number: string; text: string; element: Element }[] = [];
    let currentIndex = 0;
    let isPlaying = false;
    let isPaused = false;
    let availableVoices: SpeechSynthesisVoice[] = [];
    let selectedVoice: SpeechSynthesisVoice | null = null;

    const STORAGE_KEY = 'scholastic-bible-voice';
    const SCROLL_STORAGE_KEY = 'scholastic-bible-autoscroll';
    const SPEED_STORAGE_KEY = 'scholastic-bible-speed';

    // Load speed preference
    const savedSpeed = localStorage.getItem(SPEED_STORAGE_KEY);
    if (savedSpeed && speedSelect) {
      speedSelect.value = savedSpeed;
    }

    // macOS novelty/musical voices that aren't suitable for reading
    const NOVELTY_VOICES = new Set([
      'bad news', 'bahh', 'bells', 'boing', 'bubbles', 'cellos',
      'good news', 'jester', 'junior', 'organ', 'superstar',
      'trinoids', 'whisper', 'wobble', 'zarvox', 'albert',
      'fred', 'hysterical', 'pipe organ', 'princess', 'ralph'
    ]);

    function isNoveltyVoice(voice: SpeechSynthesisVoice): boolean {
      const name = voice.name.toLowerCase();
      return NOVELTY_VOICES.has(name) ||
             name.includes('(novelty)') ||
             name.includes('(musical)');
    }

    function scoreVoice(voice: SpeechSynthesisVoice): number {
      let score = 0;
      const name = voice.name.toLowerCase();
      const lang = voice.lang.toLowerCase();

      if (!lang.startsWith('en')) return -1000;
      if (isNoveltyVoice(voice)) return -500;
      if (lang === 'en-us' || lang === 'en-gb') score += 10;
      if (name.includes('google')) score += 50;
      if (name.includes('google uk english male')) score += 30;
      if (name.includes('enhanced') || name.includes('premium')) score += 40;
      if (name.includes('daniel')) score += 35;
      if (name.includes('samantha')) score += 25;
      if (name.includes('karen')) score += 25;
      if (name.includes('moira')) score += 25;
      if (name.includes('natural')) score += 35;
      if (name.includes('compact')) score -= 20;
      if (!voice.localService) score += 15;

      return score;
    }

    function populateVoices() {
      availableVoices = speechSynthesis.getVoices();

      const englishVoices = availableVoices
        .filter(v => v.lang.toLowerCase().startsWith('en'))
        .map(v => ({ voice: v, score: scoreVoice(v), isNovelty: isNoveltyVoice(v) }));

      const recommendedVoices = englishVoices
        .filter(v => v.score >= 40)
        .sort((a, b) => b.score - a.score);

      const standardVoices = englishVoices
        .filter(v => v.score >= 0 && v.score < 40)
        .sort((a, b) => b.score - a.score);

      const noveltyVoices = englishVoices
        .filter(v => v.isNovelty)
        .sort((a, b) => a.voice.name.localeCompare(b.voice.name));

      if (englishVoices.length === 0) {
        if (voiceSelect) voiceSelect.innerHTML = '<option value="">No English voices found</option>';
        return;
      }

      if (voiceSelect) {
        let html = '';

        if (recommendedVoices.length > 0) {
          html += '<optgroup label="Recommended">';
          html += recommendedVoices.map(({ voice }) => {
            const network = voice.localService ? '' : ' (network)';
            return `<option value="${voice.name}">${voice.name}${network}</option>`;
          }).join('');
          html += '</optgroup>';
        }

        if (standardVoices.length > 0) {
          html += '<optgroup label="Standard">';
          html += standardVoices.map(({ voice }) => {
            const network = voice.localService ? '' : ' (network)';
            return `<option value="${voice.name}">${voice.name}${network}</option>`;
          }).join('');
          html += '</optgroup>';
        }

        if (noveltyVoices.length > 0) {
          html += '<optgroup label="Novelty & Musical">';
          html += noveltyVoices.map(({ voice }) =>
            `<option value="${voice.name}">${voice.name}</option>`
          ).join('');
          html += '</optgroup>';
        }

        voiceSelect.innerHTML = html;

        const saved = localStorage.getItem(STORAGE_KEY);
        const allVoices = [...recommendedVoices, ...standardVoices, ...noveltyVoices];
        if (saved && allVoices.some(v => v.voice.name === saved)) {
          voiceSelect.value = saved;
          selectedVoice = availableVoices.find(v => v.name === saved) || null;
        } else if (recommendedVoices.length > 0) {
          voiceSelect.value = recommendedVoices[0].voice.name;
          selectedVoice = recommendedVoices[0].voice;
        } else if (standardVoices.length > 0) {
          voiceSelect.value = standardVoices[0].voice.name;
          selectedVoice = standardVoices[0].voice;
        }
      }
    }

    function gatherVerses() {
      const savedValue = verseInput?.value;
      verses = [];

      document.querySelectorAll('.verse').forEach((el) => {
        const numEl = el.querySelector('.verse-number');
        const dropCapEl = el.querySelector('.drop-cap');
        const textEl = el.querySelector('.verse-text');

        if (textEl && (numEl || dropCapEl)) {
          const verseNumber = numEl ? (numEl.textContent || '') : '1';
          const verseText = dropCapEl
            ? (dropCapEl.textContent || '') + (textEl.textContent || '')
            : (textEl.textContent || '');

          verses.push({
            number: verseNumber,
            text: verseText,
            element: el
          });
        }
      });

      if (verseInput && verses.length > 0) {
        verseInput.min = '1';
        verseInput.max = String(verses.length);

        const savedNum = parseInt(savedValue || '1', 10);
        if (savedNum >= 1 && savedNum <= verses.length) {
          verseInput.value = savedValue || '1';
        } else {
          verseInput.value = '1';
        }
      }

      if (verseTotal) {
        verseTotal.textContent = String(verses.length);
      }
    }

    // Smooth scroll with easing
    function smoothScrollTo(element: Element, duration: number = 600) {
      const targetRect = element.getBoundingClientRect();
      const targetY = targetRect.top + window.scrollY - (window.innerHeight / 2) + (targetRect.height / 2);
      const startY = window.scrollY;
      const distance = targetY - startY;
      const startTime = performance.now();

      function easeOutCubic(t: number): number {
        return 1 - Math.pow(1 - t, 3);
      }

      function scroll(currentTime: number) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const eased = easeOutCubic(progress);
        window.scrollTo(0, startY + distance * eased);
        if (progress < 1) {
          requestAnimationFrame(scroll);
        }
      }

      requestAnimationFrame(scroll);
    }

    function highlightVerse(index: number) {
      // Move current reading to was-reading for fade-out effect
      document.querySelectorAll('.verse.reading').forEach(el => {
        el.classList.remove('reading');
        el.classList.add('was-reading');
        setTimeout(() => el.classList.remove('was-reading'), 400);
      });

      // Remove any lingering was-reading classes
      document.querySelectorAll('.verse.was-reading').forEach(el => {
        el.classList.remove('was-reading');
      });

      if (verses[index]) {
        verses[index].element.classList.add('reading');
        if (autoScrollCheckbox?.checked) {
          smoothScrollTo(verses[index].element, 600);
        }
      }
    }

    // Clone buttons to remove old event listeners
    const newBtn = btn.cloneNode(true) as HTMLButtonElement;
    btn.parentNode?.replaceChild(newBtn, btn);
    const newStopBtn = stopBtn.cloneNode(true) as HTMLButtonElement;
    stopBtn.parentNode?.replaceChild(newStopBtn, stopBtn);

    const activeIconPlay = newBtn.querySelector('.icon-play') as SVGElement;
    const activeIconPause = newBtn.querySelector('.icon-pause') as SVGElement;
    const activeStatusEl = document.getElementById('narration-status') as HTMLSpanElement;

    function updateUIActive() {
      if (isPlaying && !isPaused) {
        activeIconPlay.style.display = 'none';
        activeIconPause.style.display = 'block';
        if (activeStatusEl) activeStatusEl.textContent = 'Playing';
        newStopBtn.style.display = 'flex';
      } else if (isPaused) {
        activeIconPlay.style.display = 'block';
        activeIconPause.style.display = 'none';
        if (activeStatusEl) activeStatusEl.textContent = 'Paused';
        newStopBtn.style.display = 'flex';
      } else {
        activeIconPlay.style.display = 'block';
        activeIconPause.style.display = 'none';
        if (activeStatusEl) activeStatusEl.textContent = 'Ready';
        newStopBtn.style.display = 'none';
      }
    }

    function speakVerseActive(index: number) {
      if (index >= verses.length) {
        stopActive();
        return;
      }

      currentIndex = index;
      const verse = verses[index];

      if (verseInput) {
        verseInput.value = String(index + 1);
      }

      highlightVerse(index);

      utterance = new SpeechSynthesisUtterance(verse.text);
      utterance.rate = speedSelect ? parseFloat(speedSelect.value) : 0.9;
      utterance.pitch = 1;

      if (selectedVoice) {
        utterance.voice = selectedVoice;
      }

      utterance.onend = () => {
        if (isPlaying && !isPaused) {
          speakVerseActive(index + 1);
        }
      };

      utterance.onerror = (e) => {
        if (e.error !== 'interrupted') {
          console.error('Speech error:', e);
        }
      };

      speechSynthesis.speak(utterance);
    }

    function playActive() {
      if (isPaused) {
        speechSynthesis.resume();
        isPaused = false;
        isPlaying = true;
      } else {
        gatherVerses();
        if (verses.length === 0) return;
        const inputVal = verseInput ? parseInt(verseInput.value, 10) : 1;
        const startIndex = isNaN(inputVal) ? 0 : Math.max(0, Math.min(inputVal - 1, verses.length - 1));
        currentIndex = startIndex;
        isPlaying = true;
        isPaused = false;
        speakVerseActive(currentIndex);
      }
      updateUIActive();
    }

    function pauseActive() {
      speechSynthesis.pause();
      isPaused = true;
      updateUIActive();
    }

    function stopActive() {
      speechSynthesis.cancel();
      isPlaying = false;
      isPaused = false;
      currentIndex = 0;
      document.querySelectorAll('.verse.reading').forEach(el => el.classList.remove('reading'));
      if (verseInput) {
        verseInput.value = '1';
      }
      updateUIActive();
    }

    // Load auto-scroll preference
    const savedScroll = localStorage.getItem(SCROLL_STORAGE_KEY);
    if (savedScroll !== null && autoScrollCheckbox) {
      autoScrollCheckbox.checked = savedScroll === 'true';
    }

    // Button handlers
    newBtn.addEventListener('click', () => {
      if (isPlaying && !isPaused) {
        pauseActive();
      } else {
        playActive();
      }
    });

    newStopBtn.addEventListener('click', stopActive);

    speedSelect?.addEventListener('change', () => {
      localStorage.setItem(SPEED_STORAGE_KEY, speedSelect.value);
      if (isPlaying && !isPaused) {
        speechSynthesis.cancel();
        speakVerseActive(currentIndex);
      }
    });

    autoScrollCheckbox?.addEventListener('change', () => {
      localStorage.setItem(SCROLL_STORAGE_KEY, String(autoScrollCheckbox.checked));
    });

    voiceSelect?.addEventListener('change', () => {
      const name = voiceSelect.value;
      selectedVoice = availableVoices.find(v => v.name === name) || null;
      localStorage.setItem(STORAGE_KEY, name);
      if (isPlaying && !isPaused) {
        speechSynthesis.cancel();
        speakVerseActive(currentIndex);
      }
    });

    verseInput?.addEventListener('change', () => {
      let val = parseInt(verseInput.value, 10);
      if (isNaN(val) || val < 1) val = 1;
      if (val > verses.length) val = verses.length;
      verseInput.value = String(val);

      const newIndex = val - 1;
      currentIndex = newIndex;
      if (isPlaying && !isPaused) {
        speechSynthesis.cancel();
        speakVerseActive(currentIndex);
      }
    });

    populateVoices();
    if (speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = populateVoices;
    }

    gatherVerses();
    document.addEventListener('astro:before-preparation', stopActive);

    // Global spacebar handler for play/pause
    function handleKeydown(e: KeyboardEvent) {
      if (e.code !== 'Space') return;

      const target = e.target as HTMLElement;
      if (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.tagName === 'SELECT') {
        return;
      }

      e.preventDefault();

      if (isPlaying && !isPaused) {
        pauseActive();
      } else {
        playActive();
      }
    }

    document.addEventListener('keydown', handleKeydown);
    document.addEventListener('astro:before-preparation', () => {
      document.removeEventListener('keydown', handleKeydown);
    }, { once: true });
  }

  // Run on initial load and after View Transitions navigation
  document.addEventListener('astro:page-load', setupNarration);
</script>

<style>
  .narration-bar {
    margin-bottom: 2rem;
    background: linear-gradient(135deg, var(--color-patched) 0%, color-mix(in srgb, var(--color-patched) 80%, var(--color-bg)) 100%);
    border-radius: 8px;
    border: 1px solid var(--color-border);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), inset 0 1px 0 rgba(255, 255, 255, 0.5);
    overflow: hidden;
  }

  [data-theme="dark"] .narration-bar {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.05);
  }

  .narration-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--color-border);
    background: linear-gradient(to bottom, transparent, rgba(0, 0, 0, 0.02));
  }

  [data-theme="dark"] .narration-header {
    background: linear-gradient(to bottom, transparent, rgba(0, 0, 0, 0.1));
  }

  .narration-icon {
    color: var(--color-accent);
    flex-shrink: 0;
  }

  .narration-title {
    font-family: var(--font-heading);
    font-size: 0.9rem;
    font-weight: 500;
    letter-spacing: 0.03em;
    color: var(--color-text);
    text-transform: uppercase;
  }

  .narration-mode {
    margin-left: auto;
    font-family: var(--font-sans);
    font-size: 0.7rem;
    font-weight: 500;
    color: var(--color-muted);
    background: color-mix(in srgb, var(--color-accent) 15%, transparent);
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .narration-controls {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.875rem 1rem;
    flex-wrap: wrap;
  }

  .playback-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .narration-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    background: linear-gradient(135deg, var(--color-accent) 0%, color-mix(in srgb, var(--color-accent) 85%, black) 100%);
    color: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 6px rgba(139, 69, 19, 0.3);
  }

  .narration-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(139, 69, 19, 0.4);
  }

  .narration-btn:active {
    transform: scale(0.98);
  }

  .narration-stop {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: var(--color-bg);
    color: var(--color-muted);
    border: 1px solid var(--color-border);
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .narration-stop:hover {
    background: color-mix(in srgb, var(--color-accent) 10%, var(--color-bg));
    color: var(--color-accent);
    border-color: var(--color-accent);
  }

  .narration-status {
    font-family: var(--font-sans);
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--color-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    min-width: 50px;
  }

  .narration-divider {
    width: 1px;
    height: 28px;
    background: var(--color-border);
    margin: 0 0.25rem;
  }

  /* Progress bar for audio mode */
  .progress-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex: 1;
    min-width: 150px;
    max-width: 300px;
  }

  .time-display {
    font-family: var(--font-mono, monospace);
    font-size: 0.75rem;
    color: var(--color-muted);
    min-width: 35px;
    text-align: center;
  }

  .progress-bar {
    flex: 1;
    height: 6px;
    -webkit-appearance: none;
    appearance: none;
    background: var(--color-border);
    border-radius: 3px;
    cursor: pointer;
  }

  .progress-bar::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px;
    height: 14px;
    background: var(--color-accent);
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    margin-top: -4px; /* Center thumb on 6px track: (14-6)/2 */
  }

  .progress-bar::-moz-range-thumb {
    width: 14px;
    height: 14px;
    background: var(--color-accent);
    border-radius: 50%;
    cursor: pointer;
    border: none;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
  }

  .progress-bar::-webkit-slider-runnable-track {
    height: 6px;
    background: var(--color-border);
    border-radius: 3px;
  }

  .progress-bar::-moz-range-track {
    height: 6px;
    background: var(--color-border);
    border-radius: 3px;
  }

  /* Verse selector (TTS mode) */
  .verse-selector,
  .speed-selector {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
  }

  .control-label {
    font-family: var(--font-sans);
    font-size: 0.65rem;
    font-weight: 600;
    color: var(--color-muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .verse-progress {
    display: flex;
    align-items: center;
    gap: 0.3rem;
    font-family: var(--font-sans);
    font-size: 0.85rem;
    color: var(--color-text);
  }

  .verse-num-input {
    font-family: var(--font-sans);
    font-size: 0.85rem;
    font-weight: 600;
    padding: 0.2rem 0.4rem;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    background: var(--color-bg);
    color: var(--color-text);
    width: 48px;
    text-align: center;
    transition: border-color 0.15s ease;
    -moz-appearance: textfield;
  }

  .verse-num-input::-webkit-outer-spin-button,
  .verse-num-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .verse-num-input:hover,
  .verse-num-input:focus {
    border-color: var(--color-accent);
    outline: none;
  }

  .verse-total {
    color: var(--color-muted);
    font-weight: 400;
  }

  .speed-select {
    font-family: var(--font-sans);
    font-size: 0.85rem;
    padding: 0.2rem 0.4rem;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    background: var(--color-bg);
    color: var(--color-text);
    cursor: pointer;
    transition: border-color 0.15s ease;
    min-width: 55px;
  }

  .speed-select:hover,
  .speed-select:focus {
    border-color: var(--color-accent);
    outline: none;
  }

  .scroll-toggle {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    cursor: pointer;
    font-family: var(--font-sans);
    font-size: 0.75rem;
    color: var(--color-muted);
    padding: 0.4rem 0.6rem;
    border-radius: 4px;
    transition: all 0.15s ease;
    margin-left: auto;
  }

  .scroll-toggle:hover {
    background: color-mix(in srgb, var(--color-accent) 8%, transparent);
    color: var(--color-text);
  }

  .scroll-toggle input {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
  }

  .scroll-icon {
    color: var(--color-muted);
    transition: color 0.15s ease;
  }

  .scroll-toggle input:checked ~ .scroll-icon {
    color: var(--color-accent);
  }

  .scroll-label {
    user-select: none;
    font-weight: 500;
  }

  .scroll-toggle input:checked ~ .scroll-label {
    color: var(--color-text);
  }

  .voice-row {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.6rem 1rem;
    background: color-mix(in srgb, var(--color-bg) 50%, transparent);
    border-top: 1px solid var(--color-border);
  }

  .voice-icon {
    color: var(--color-muted);
    flex-shrink: 0;
  }

  .voice-label {
    font-family: var(--font-sans);
    font-size: 0.75rem;
    color: var(--color-muted);
    font-weight: 500;
  }

  .voice-select {
    font-family: var(--font-sans);
    font-size: 0.8rem;
    padding: 0.3rem 0.5rem;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    background: var(--color-bg);
    color: var(--color-text);
    flex: 1;
    max-width: 280px;
    cursor: pointer;
    transition: border-color 0.15s ease;
  }

  .voice-select:hover,
  .voice-select:focus {
    border-color: var(--color-accent);
    outline: none;
  }

  /* Hidden audio element */
  #audio-player {
    display: none;
  }

  /* Smooth transitions for verse highlighting */
  :global(.verse) {
    transition: background-color 0.4s ease,
                border-left-color 0.4s ease,
                box-shadow 0.4s ease;
    border-left: 3px solid transparent;
    margin-left: -0.5rem;
    padding-left: calc(0.5rem - 3px);
    padding-right: 0.5rem;
    margin-right: -0.5rem;
    border-radius: 3px;
  }

  /* Highlight currently reading verse */
  :global(.verse.reading) {
    background: var(--color-highlight) !important;
    border-left-color: var(--color-accent);
    box-shadow: 0 2px 8px rgba(139, 69, 19, 0.1);
  }

  /* Fade out effect for verse that was just read */
  :global(.verse.was-reading) {
    background: color-mix(in srgb, var(--color-highlight) 30%, transparent);
    border-left-color: color-mix(in srgb, var(--color-accent) 30%, transparent);
  }

  @media (max-width: 600px) {
    .narration-controls {
      gap: 0.5rem;
    }

    .narration-divider {
      display: none;
    }

    .scroll-toggle {
      margin-left: 0;
    }

    .verse-selector,
    .speed-selector {
      flex-direction: row;
      align-items: center;
      gap: 0.4rem;
    }

    .control-label {
      font-size: 0.7rem;
    }

    .voice-row {
      flex-wrap: wrap;
    }

    .voice-select {
      max-width: none;
      width: 100%;
    }

    .progress-container {
      width: 100%;
      max-width: none;
      order: 10;
    }

    .narration-mode {
      display: none;
    }
  }
</style>
