---
interface Props {
  bookId: string;
  chapter: number;
}

const { bookId, chapter } = Astro.props;
---

<div class="reading-progress" data-book={bookId} data-chapter={chapter}>
  <label class="read-checkbox">
    <input type="checkbox" class="read-input" />
    <span class="seal">
      <span class="seal-icon">✓</span>
    </span>
    <span class="read-text">
      <span class="read-label">Mark as read</span>
      <span class="read-label-done">Chapter complete</span>
    </span>
    <span class="flourish-left">❧</span>
    <span class="flourish-right">❧</span>
  </label>
</div>

<style>
  .reading-progress {
    margin: 2rem 0;
    display: flex;
    justify-content: center;
  }

  .read-checkbox {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    font-family: var(--font-heading);
    font-size: 0.95rem;
    color: var(--color-muted);
    padding: 0.75rem 1.5rem;
    border: 1px solid var(--color-border);
    border-radius: 30px;
    background: var(--color-bg);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .read-checkbox:hover {
    color: var(--color-text);
    border-color: var(--color-accent);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .read-input {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
  }

  /* Custom seal/stamp checkbox */
  .seal {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 2px solid var(--color-border);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    position: relative;
    background: var(--color-bg);
  }

  .seal-icon {
    opacity: 0;
    transform: scale(0) rotate(-180deg);
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    color: white;
    font-size: 0.9rem;
    font-weight: bold;
  }

  .read-checkbox:hover .seal {
    border-color: var(--color-accent);
  }

  /* Checked state - wax seal effect */
  .read-input:checked ~ .seal {
    background: var(--book-color, var(--color-accent));
    border-color: var(--book-color, var(--color-accent));
    box-shadow:
      0 2px 8px rgba(139, 69, 19, 0.3),
      inset 0 -2px 4px rgba(0, 0, 0, 0.2),
      inset 0 2px 4px rgba(255, 255, 255, 0.2);
    animation: stamp 0.4s ease;
  }

  .read-input:checked ~ .seal .seal-icon {
    opacity: 1;
    transform: scale(1) rotate(0deg);
  }

  @keyframes stamp {
    0% { transform: scale(1); }
    30% { transform: scale(1.3); }
    50% { transform: scale(0.9); }
    70% { transform: scale(1.1); }
    100% { transform: scale(1); }
  }

  /* Text labels */
  .read-text {
    display: flex;
    flex-direction: column;
    line-height: 1.2;
  }

  .read-label-done {
    display: none;
    color: var(--book-color, var(--color-accent));
    font-weight: 500;
  }

  .read-input:checked ~ .read-text .read-label {
    display: none;
  }

  .read-input:checked ~ .read-text .read-label-done {
    display: block;
  }

  /* Flourishes */
  .flourish-left,
  .flourish-right {
    position: absolute;
    font-size: 0.8rem;
    color: var(--book-color, var(--color-accent));
    opacity: 0;
    transition: all 0.4s ease;
  }

  .flourish-left {
    left: 0.5rem;
    transform: translateX(10px) scaleX(-1);
  }

  .flourish-right {
    right: 0.5rem;
    transform: translateX(-10px);
  }

  .read-input:checked ~ .flourish-left,
  .read-input:checked ~ .flourish-right {
    opacity: 1;
  }

  .read-input:checked ~ .flourish-left {
    transform: translateX(0) scaleX(-1);
  }

  .read-input:checked ~ .flourish-right {
    transform: translateX(0);
  }

  /* Checked container state */
  .read-checkbox:has(.read-input:checked) {
    border-color: var(--book-color, var(--color-accent));
    background: color-mix(in srgb, var(--book-color, var(--color-accent)) 5%, var(--color-bg));
  }
</style>

<script>
  function setupReadingProgress() {
    const container = document.querySelector('.reading-progress');
    if (!container) return;

    const bookId = container.dataset.book;
    const chapter = parseInt(container.dataset.chapter, 10);
    const checkbox = container.querySelector('.read-input') as HTMLInputElement;
    if (!checkbox) return;

    const STORAGE_KEY = 'scholastic-bible-read';

    // Get current read status
    function getReadChapters(): Record<string, number[]> {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        return stored ? JSON.parse(stored) : {};
      } catch {
        return {};
      }
    }

    // Save read status
    function saveReadChapters(data: Record<string, number[]>) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    // Check if this chapter is read
    function isChapterRead(): boolean {
      const data = getReadChapters();
      return data[bookId]?.includes(chapter) ?? false;
    }

    // Toggle read status
    function setChapterRead(read: boolean) {
      const data = getReadChapters();
      if (!data[bookId]) {
        data[bookId] = [];
      }

      if (read && !data[bookId].includes(chapter)) {
        data[bookId].push(chapter);
        data[bookId].sort((a, b) => a - b);
      } else if (!read) {
        data[bookId] = data[bookId].filter(c => c !== chapter);
      }

      saveReadChapters(data);
    }

    // Initialize
    checkbox.checked = isChapterRead();

    // Clone to remove old listeners, then add new one
    const newCheckbox = checkbox.cloneNode(true) as HTMLInputElement;
    checkbox.parentNode?.replaceChild(newCheckbox, checkbox);
    newCheckbox.checked = isChapterRead();

    newCheckbox.addEventListener('change', () => {
      setChapterRead(newCheckbox.checked);
    });
  }

  // Run on initial load and after View Transitions navigation
  document.addEventListener('astro:page-load', setupReadingProgress);
</script>
