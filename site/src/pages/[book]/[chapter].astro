---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Verse from '../../components/Verse.astro';
import VerseDivider from '../../components/VerseDivider.astro';
import Navigation from '../../components/Navigation.astro';
import Narration from '../../components/Narration.astro';
import ReadingProgress from '../../components/ReadingProgress.astro';
import bible from '../../data/bible.json';
import fs from 'node:fs';
import path from 'node:path';

export function getStaticPaths() {
  const paths = [];

  for (const book of bible.books) {
    for (let i = 0; i < book.chapters.length; i++) {
      paths.push({
        params: {
          book: book.id,
          chapter: String(i + 1)
        },
        props: {
          book,
          chapterIndex: i,
          chapterData: book.chapters[i]
        }
      });
    }
  }

  return paths;
}

const { book, chapterIndex, chapterData } = Astro.props;
const chapterNum = chapterIndex + 1;
const totalChapters = book.chapters.length;
const base = import.meta.env.BASE_URL;

// Check if chapter header image exists (v1 and v2)
const imagePath = `images/chapters/${book.id}-${chapterNum}.png`;
const imagePathV2 = `images/chapters/${book.id}-${chapterNum}-v2.png`;
const fullImagePath = path.join(process.cwd(), 'public', imagePath);
const fullImagePathV2 = path.join(process.cwd(), 'public', imagePathV2);
const hasHeaderImage = fs.existsSync(fullImagePath);
const hasV2Image = fs.existsSync(fullImagePathV2);

// Navigation links
const prevLink = chapterNum > 1
  ? { href: `${base}${book.id}/${chapterNum - 1}/`, label: `Chapter ${chapterNum - 1}` }
  : undefined;

const nextLink = chapterNum < totalChapters
  ? { href: `${base}${book.id}/${chapterNum + 1}/`, label: `Chapter ${chapterNum + 1}` }
  : undefined;
---

<BaseLayout title={`${book.name} ${chapterNum}`} bookId={book.id}>
  <Fragment slot="breadcrumb">
    <span class="breadcrumb">
      <span>/</span>
      <a href={`${base}${book.id}/`}>{book.name}</a>
      <span>/</span>
      <span>Chapter {chapterNum}</span>
    </span>
  </Fragment>

  {hasHeaderImage ? (
    <div class="hero">
      <img
        src={`${base}${imagePath}`}
        alt={`${book.name} ${chapterNum}`}
        class="hero-image"
        data-v1={`${base}${imagePath}`}
        data-v2={hasV2Image ? `${base}${imagePathV2}` : ''}
      />
      <div class="hero-overlay">
        <h1>{book.name} {chapterNum}</h1>
      </div>
      {hasV2Image && (
        <button class="version-toggle" aria-label="Switch image version">
          <span class="version-label">v1</span>
        </button>
      )}
    </div>
  ) : (
    <h1>{book.name} {chapterNum}</h1>
  )}

  {chapterData.summary && (
    <p class="chapter-summary">{chapterData.summary}</p>
  )}

  <Narration />

  <div class="verses">
    {chapterData.verses.map((verse, index) => (
      <>
        {index > 0 && index % 5 === 0 && <VerseDivider />}
        <Verse
          number={verse.number}
          text={verse.text}
          patched={verse.patched}
          footnotes={verse.footnotes}
          isFirst={index === 0}
        />
      </>
    ))}
  </div>

  <ReadingProgress bookId={book.id} chapter={chapterNum} />

  <Navigation prevLink={prevLink} nextLink={nextLink} />
</BaseLayout>

<style>
  .hero {
    position: relative;
    margin: 0 auto 2rem auto;
    max-width: 800px;
    border-radius: 8px;
    overflow: hidden;
  }

  .hero-image {
    width: 100%;
    height: auto;
    display: block;
  }

  .hero-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 2rem 1.5rem 1.5rem;
    background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
  }

  .hero-overlay h1 {
    color: white;
    margin: 0;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
  }

  .chapter-summary {
    font-style: italic;
    color: var(--color-muted);
    border-left: 3px solid var(--color-accent);
    padding-left: 1rem;
    margin-bottom: 1.5rem;
  }

  .verses {
    margin-top: 1.5rem;
  }

  .version-toggle {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    cursor: pointer;
    color: white;
    font-size: 0.75rem;
    font-weight: 500;
    transition: background 0.2s;
  }

  .version-toggle:hover {
    background: rgba(0, 0, 0, 0.8);
  }

  .version-label {
    pointer-events: none;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const toggle = document.querySelector('.version-toggle');
    if (!toggle) return;

    const img = document.querySelector('.hero-image');
    const label = toggle.querySelector('.version-label');
    const v1Src = img.dataset.v1;
    const v2Src = img.dataset.v2;

    if (!v2Src) return;

    // Check localStorage for preference
    const pageKey = window.location.pathname;
    const stored = localStorage.getItem(`img-version-${pageKey}`);
    let currentVersion = stored === 'v2' ? 'v2' : 'v1';

    // Apply stored preference
    if (currentVersion === 'v2') {
      img.src = v2Src;
      label.textContent = 'v2';
    }

    toggle.addEventListener('click', () => {
      if (currentVersion === 'v1') {
        img.src = v2Src;
        label.textContent = 'v2';
        currentVersion = 'v2';
      } else {
        img.src = v1Src;
        label.textContent = 'v1';
        currentVersion = 'v1';
      }
      localStorage.setItem(`img-version-${pageKey}`, currentVersion);
    });
  });
</script>
