---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ChapterList from '../../components/ChapterList.astro';
import bible from '../../data/bible.json';
import fs from 'node:fs';
import path from 'node:path';

export function getStaticPaths() {
  return bible.books.map(book => ({
    params: { book: book.id },
    props: { book }
  }));
}

const { book } = Astro.props;

// Check if book header image exists (v1 and v2)
const imagePath = `images/books/${book.id}.png`;
const imagePathV2 = `images/books/${book.id}-v2.png`;
const fullImagePath = path.join(process.cwd(), 'public', imagePath);
const fullImagePathV2 = path.join(process.cwd(), 'public', imagePathV2);
const hasHeaderImage = fs.existsSync(fullImagePath);
const hasV2Image = fs.existsSync(fullImagePathV2);

// Check which chapters have illustrations
function hasChapterImage(chapterNum: number): boolean {
  const chapterImagePath = path.join(process.cwd(), 'public', 'images', 'chapters', `${book.id}-${chapterNum}.png`);
  return fs.existsSync(chapterImagePath);
}
---

<BaseLayout title={book.name}>
  <Fragment slot="breadcrumb">
    <span class="breadcrumb">
      <span>/</span>
      <span>{book.name}</span>
    </span>
  </Fragment>

  {hasHeaderImage ? (
    <div class="hero">
      <img
        src={`${import.meta.env.BASE_URL}${imagePath}`}
        alt={book.name}
        class="hero-image"
        data-v1={`${import.meta.env.BASE_URL}${imagePath}`}
        data-v2={hasV2Image ? `${import.meta.env.BASE_URL}${imagePathV2}` : ''}
      />
      <div class="hero-overlay">
        <h1>{book.name}</h1>
      </div>
      {hasV2Image && (
        <button class="version-toggle" aria-label="Switch image version">
          <span class="version-label">v1</span>
        </button>
      )}
    </div>
  ) : (
    <h1>{book.name}</h1>
  )}

  {book.introduction && (
    <div class="book-intro">
      <p>{book.introduction}</p>
    </div>
  )}

  <h2 class="chapter-heading">Chapters</h2>

  <ChapterList
    bookId={book.id}
    bookName={book.name}
    chapters={book.chapters.map(c => ({ number: c.number, editCount: c.editCount, footnoteCount: c.footnoteCount, hasIllustration: hasChapterImage(c.number) }))}
  />
</BaseLayout>

<style>
  .hero {
    position: relative;
    margin: 0 auto 2rem auto;
    max-width: 800px;
    border-radius: 8px;
    overflow: hidden;
  }

  .hero-image {
    width: 100%;
    height: auto;
    display: block;
  }

  .hero-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 2rem 1.5rem 1.5rem;
    background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
  }

  .hero-overlay h1 {
    color: white;
    margin: 0;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
  }

  .book-intro {
    background: var(--color-patched);
    border-left: 3px solid var(--color-accent);
    padding: 1rem 1.25rem;
    margin-bottom: 2rem;
    font-style: italic;
    color: var(--color-muted);
    line-height: 1.6;
  }

  .chapter-heading {
    font-size: 1.25rem;
    color: var(--color-muted);
    margin-bottom: 0.5rem;
    font-weight: normal;
  }

  .version-toggle {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    cursor: pointer;
    color: white;
    font-size: 0.75rem;
    font-weight: 500;
    transition: background 0.2s;
  }

  .version-toggle:hover {
    background: rgba(0, 0, 0, 0.8);
  }

  .version-label {
    pointer-events: none;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const toggle = document.querySelector('.version-toggle');
    if (!toggle) return;

    const img = document.querySelector('.hero-image');
    const label = toggle.querySelector('.version-label');
    const v1Src = img.dataset.v1;
    const v2Src = img.dataset.v2;

    if (!v2Src) return;

    // Check localStorage for preference
    const pageKey = window.location.pathname;
    const stored = localStorage.getItem(`img-version-${pageKey}`);
    let currentVersion = stored === 'v2' ? 'v2' : 'v1';

    // Apply stored preference
    if (currentVersion === 'v2') {
      img.src = v2Src;
      label.textContent = 'v2';
    }

    toggle.addEventListener('click', () => {
      if (currentVersion === 'v1') {
        img.src = v2Src;
        label.textContent = 'v2';
        currentVersion = 'v2';
      } else {
        img.src = v1Src;
        label.textContent = 'v1';
        currentVersion = 'v1';
      }
      localStorage.setItem(`img-version-${pageKey}`, currentVersion);
    });
  });
</script>
