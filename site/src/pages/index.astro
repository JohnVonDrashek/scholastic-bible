---
import BaseLayout from '../layouts/BaseLayout.astro';
import BookList from '../components/BookList.astro';
import bible from '../data/bible.json';
import fs from 'node:fs';
import path from 'node:path';

// Traditional Bible book groupings
const PENTATEUCH = ['genesis', 'exodus', 'leviticus', 'numbers', 'deuteronomy'];
const HISTORICAL = ['josue', 'judges', 'ruth', '1-samuel', '2-samuel', '1-kings', '2-kings', '1-chronicles', '2-chronicles', 'ezra', 'nehemiah', 'tobias', 'judith', 'esther', '1-machabees', '2-machabees'];
const WISDOM = ['job', 'psalms', 'proverbs', 'ecclesiastes', 'canticles', 'wisdom', 'ecclesiasticus'];
const MAJOR_PROPHETS = ['isaias', 'jeremias', 'lamentations', 'baruch', 'ezechiel', 'daniel'];
const MINOR_PROPHETS = ['osee', 'joel', 'amos', 'abdias', 'jonas', 'micheas', 'nahum', 'habacuc', 'sophonias', 'aggeus', 'zacharias', 'malachias'];

const GOSPELS = ['matthew', 'mark', 'luke', 'john'];
const ACTS = ['acts'];
const PAULINE = ['romans', '1-corinthians', '2-corinthians', 'galatians', 'ephesians', 'philippians', 'colossians', '1-thessalonians', '2-thessalonians', '1-timothy', '2-timothy', 'titus', 'philemon', 'hebrews'];
const CATHOLIC_EPISTLES = ['james', '1-peter', '2-peter', '1-john', '2-john', '3-john', 'jude'];
const APOCALYPSE = ['apocalypse'];

const OT_BOOKS = [...PENTATEUCH, ...HISTORICAL, ...WISDOM, ...MAJOR_PROPHETS, ...MINOR_PROPHETS];

// Count illustrations per book
function countIllustrations(bookId: string): number {
  let count = 0;

  // Check for book header image
  const bookImagePath = path.join(process.cwd(), 'public', 'images', 'books', `${bookId}.png`);
  if (fs.existsSync(bookImagePath)) count++;

  // Check for chapter images
  const chaptersDir = path.join(process.cwd(), 'public', 'images', 'chapters');
  if (fs.existsSync(chaptersDir)) {
    const files = fs.readdirSync(chaptersDir);
    count += files.filter(f => f.startsWith(`${bookId}-`) && f.endsWith('.png')).length;
  }

  return count;
}

// Helper to get books by IDs in order
function getBooks(ids: string[]) {
  return ids
    .map(id => bible.books.find(b => b.id === id))
    .filter(Boolean)
    .map(b => ({ id: b.id, name: b.name, chapters: b.chapters.length, editCount: b.editCount, footnoteCount: b.footnoteCount, challonerCount: b.challonerCount, illustrationCount: countIllustrations(b.id) }));
}

// Old Testament groups
const pentateuchBooks = getBooks(PENTATEUCH);
const historicalBooks = getBooks(HISTORICAL);
const wisdomBooks = getBooks(WISDOM);
const majorProphetBooks = getBooks(MAJOR_PROPHETS);
const minorProphetBooks = getBooks(MINOR_PROPHETS);

// New Testament groups
const gospelBooks = getBooks(GOSPELS);
const actsBooks = getBooks(ACTS);
const paulineBooks = getBooks(PAULINE);
const catholicBooks = getBooks(CATHOLIC_EPISTLES);
const apocalypseBooks = getBooks(APOCALYPSE);
---

<BaseLayout title="Home" parallaxBg={`${import.meta.env.BASE_URL}images/homepage-bg.png`}>
  <div class="hero">
    <img src={`${import.meta.env.BASE_URL}header.png`} alt="Scholastic Bible - Medieval illuminated manuscript style" class="hero-image" />
    <div class="hero-overlay">
      <h1>Scholastic Bible</h1>
      <p class="intro">
        A study-oriented translation based on the Douay-Rheims text with scholastic commentary and annotations.
      </p>
    </div>
  </div>

  <h2 class="testament-heading">Old Testament</h2>
  <BookList title="Pentateuch" books={pentateuchBooks} />
  <BookList title="Historical Books" books={historicalBooks} />
  <BookList title="Wisdom Books" books={wisdomBooks} />
  <BookList title="Major Prophets" books={majorProphetBooks} />
  <BookList title="Minor Prophets" books={minorProphetBooks} />

  <h2 class="testament-heading">New Testament</h2>
  <BookList title="Gospels" books={gospelBooks} />
  <BookList title="Acts of the Apostles" books={actsBooks} />
  <BookList title="Pauline Epistles" books={paulineBooks} />
  <BookList title="Catholic Epistles" books={catholicBooks} />
  <BookList title="Apocalypse" books={apocalypseBooks} />

  <h2 class="testament-heading">Supplementary Materials</h2>
  <div class="supplementary-grid">
    <a href={`${import.meta.env.BASE_URL}glossary`} class="supp-card">
      <h3>Hard Vvordes Explicated</h3>
      <p>Glossary of archaic terms and theological vocabulary used in the translation</p>
    </a>
    <a href={`${import.meta.env.BASE_URL}preface`} class="supp-card">
      <h3>Preface to the Reader</h3>
      <p>The original translators' preface explaining their approach to this edition</p>
    </a>
    <a href={`${import.meta.env.BASE_URL}prayer-of-manasses`} class="supp-card">
      <h3>Prayer of Manasses</h3>
      <p>The penitential prayer of King Manasses of Judah</p>
    </a>
    <a href={`${import.meta.env.BASE_URL}3-esdras`} class="supp-card">
      <h3>Third Book of Esdras</h3>
      <p>Apocryphal text paralleling Chronicles, Ezra, and Nehemiah</p>
    </a>
    <a href={`${import.meta.env.BASE_URL}4-esdras`} class="supp-card">
      <h3>Fourth Book of Esdras</h3>
      <p>Apocalyptic visions addressing divine justice and Israel's destiny</p>
    </a>
  </div>
</BaseLayout>

<style>
  .hero {
    position: relative;
    margin: 0 auto 2rem auto;
    max-width: 800px;
    border-radius: 8px;
    overflow: hidden;
  }

  .hero-image {
    width: 100%;
    height: auto;
    display: block;
  }

  .hero-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 2rem 1.5rem 1.5rem;
    background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
  }

  .hero-overlay h1 {
    color: white;
    margin: 0 0 0.5rem 0;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
  }

  .intro {
    font-style: italic;
    color: rgba(255, 255, 255, 0.9);
    margin: 0;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
  }

  .testament-heading {
    font-size: 1.75rem;
    font-weight: normal;
    margin: 2.5rem 0 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--color-accent);
    color: var(--color-text);
  }

  .testament-heading:first-of-type {
    margin-top: 1.5rem;
  }

  .supplementary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
  }

  .supp-card {
    display: block;
    padding: 1.25rem;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .supp-card:hover {
    border-color: var(--color-accent);
    background: color-mix(in srgb, var(--color-accent) 5%, var(--color-bg));
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .supp-card h3 {
    font-family: var(--font-heading);
    font-size: 1.1rem;
    font-weight: 500;
    color: var(--color-text);
    margin: 0 0 0.5rem 0;
  }

  .supp-card p {
    font-size: 0.9rem;
    color: var(--color-muted);
    margin: 0;
    line-height: 1.5;
  }
</style>
