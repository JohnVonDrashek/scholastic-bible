---
import BaseLayout from '../layouts/BaseLayout.astro';
import BookList from '../components/BookList.astro';
import bible from '../data/bible.json';
import fs from 'node:fs';
import path from 'node:path';

const OT_BOOKS = [
  'genesis', 'exodus', 'leviticus', 'numbers', 'deuteronomy',
  'josue', 'judges', 'ruth', '1-samuel', '2-samuel',
  '1-kings', '2-kings', '1-chronicles', '2-chronicles',
  'ezra', 'nehemiah', 'tobias', 'judith', 'esther',
  'job', 'psalms', 'proverbs', 'ecclesiastes', 'canticles',
  'wisdom', 'ecclesiasticus', 'isaias', 'jeremias', 'lamentations',
  'baruch', 'ezechiel', 'daniel', 'osee', 'joel', 'amos',
  'abdias', 'jonas', 'micheas', 'nahum', 'habacuc', 'sophonias',
  'aggeus', 'zacharias', 'malachias', '1-machabees', '2-machabees'
];

// Count illustrations per book
function countIllustrations(bookId: string): number {
  let count = 0;

  // Check for book header image
  const bookImagePath = path.join(process.cwd(), 'public', 'images', 'books', `${bookId}.png`);
  if (fs.existsSync(bookImagePath)) count++;

  // Check for chapter images
  const chaptersDir = path.join(process.cwd(), 'public', 'images', 'chapters');
  if (fs.existsSync(chaptersDir)) {
    const files = fs.readdirSync(chaptersDir);
    count += files.filter(f => f.startsWith(`${bookId}-`) && f.endsWith('.png')).length;
  }

  return count;
}

const otBooks = bible.books
  .filter(b => OT_BOOKS.includes(b.id))
  .map(b => ({ id: b.id, name: b.name, chapters: b.chapters.length, editCount: b.editCount, footnoteCount: b.footnoteCount, illustrationCount: countIllustrations(b.id) }));

const ntBooks = bible.books
  .filter(b => !OT_BOOKS.includes(b.id))
  .map(b => ({ id: b.id, name: b.name, chapters: b.chapters.length, editCount: b.editCount, footnoteCount: b.footnoteCount, illustrationCount: countIllustrations(b.id) }));
---

<BaseLayout title="Home">
  <div class="hero">
    <img src={`${import.meta.env.BASE_URL}header.png`} alt="Scholastic Bible - Medieval illuminated manuscript style" class="hero-image" />
    <div class="hero-overlay">
      <h1>Scholastic Bible</h1>
      <p class="intro">
        A study-oriented translation based on the Douay-Rheims text with scholastic commentary and annotations.
      </p>
    </div>
  </div>

  <BookList title="Old Testament" books={otBooks} />
  <BookList title="New Testament" books={ntBooks} />
</BaseLayout>

<style>
  .hero {
    position: relative;
    margin: 0 auto 2rem auto;
    max-width: 800px;
    border-radius: 8px;
    overflow: hidden;
  }

  .hero-image {
    width: 100%;
    height: auto;
    display: block;
  }

  .hero-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 2rem 1.5rem 1.5rem;
    background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
  }

  .hero-overlay h1 {
    color: white;
    margin: 0 0 0.5rem 0;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
  }

  .intro {
    font-style: italic;
    color: rgba(255, 255, 255, 0.9);
    margin: 0;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
  }
</style>
