---
import BaseLayout from '../layouts/BaseLayout.astro';

const base = import.meta.env.BASE_URL;
---

<BaseLayout title="Search">
  <h1>Search the Bible</h1>

  <div class="search-container">
    <input
      type="search"
      id="search-input"
      placeholder="Search text or enter a reference (e.g., John 3:16)..."
      autocomplete="off"
      autofocus
    />
    <div id="search-status" class="search-status"></div>
  </div>

  <div id="search-results" class="search-results"></div>
</BaseLayout>

<style>
  .search-container {
    margin-bottom: 2rem;
  }

  #search-input {
    width: 100%;
    padding: 1rem 1.25rem;
    font-size: 1.1rem;
    font-family: var(--font-serif);
    border: 2px solid var(--color-border);
    border-radius: 8px;
    background: var(--color-bg);
    color: var(--color-text);
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  #search-input:focus {
    outline: none;
    border-color: var(--color-accent);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-accent) 20%, transparent);
  }

  #search-input::placeholder {
    color: var(--color-muted);
  }

  .search-status {
    margin-top: 0.75rem;
    font-size: 0.9rem;
    color: var(--color-muted);
    min-height: 1.5em;
  }

  .search-status.loading::after {
    content: '...';
    animation: dots 1s steps(3, end) infinite;
  }

  @keyframes dots {
    0%, 20% { content: '.'; }
    40% { content: '..'; }
    60%, 100% { content: '...'; }
  }

  .search-results {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  :global(.search-result) {
    padding: 1rem 1.25rem;
    border: 1px solid var(--color-border);
    border-radius: 8px;
    background: var(--color-bg);
    text-decoration: none;
    color: inherit;
    display: block;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  :global(.search-result:hover) {
    border-color: var(--color-accent);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  :global(.search-result .ref) {
    font-family: var(--font-heading);
    font-size: 1rem;
    font-weight: 500;
    color: var(--color-accent);
    margin-bottom: 0.5rem;
  }

  :global(.search-result .snippet) {
    font-size: 0.95rem;
    line-height: 1.6;
    color: var(--color-text);
  }

  :global(.search-result .snippet mark) {
    background: var(--color-highlight);
    color: inherit;
    padding: 0 0.15em;
    border-radius: 2px;
  }

  :global(.search-result .match-type) {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    margin-top: 0.5rem;
    font-size: 0.8rem;
    color: var(--color-muted);
  }

  :global(.no-results) {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--color-muted);
  }

  :global(.no-results h2) {
    margin-bottom: 0.5rem;
  }
</style>

<script define:vars={{ base }}>
  // Store base URL for use in client script
  window.__BASE_URL__ = base;
</script>

<script>
  import Fuse from 'fuse.js';

  interface Verse {
    id: string;
    ref: string;
    book: string;
    bookName: string;
    chapter: number;
    verse: number;
    text: string;
    footnotes: string[] | null;
    challoner: string[] | null;
    summary: string | null;
  }

  interface SearchIndex {
    verses: Verse[];
  }

  let fuse: Fuse<Verse> | null = null;
  let searchIndex: SearchIndex | null = null;
  let debounceTimer: number | null = null;

  const base = (window as any).__BASE_URL__ || '/';

  // Book name to ID mapping (includes DR names, modern names, and abbreviations)
  const bookMap: Record<string, string> = {
    // Pentateuch
    'genesis': 'genesis', 'gen': 'genesis', 'gn': 'genesis',
    'exodus': 'exodus', 'exod': 'exodus', 'ex': 'exodus',
    'leviticus': 'leviticus', 'lev': 'leviticus', 'lv': 'leviticus',
    'numbers': 'numbers', 'num': 'numbers', 'nm': 'numbers',
    'deuteronomy': 'deuteronomy', 'deut': 'deuteronomy', 'dt': 'deuteronomy',
    // Historical
    'josue': 'josue', 'joshua': 'josue', 'jos': 'josue', 'josh': 'josue',
    'judges': 'judges', 'judg': 'judges', 'jgs': 'judges',
    'ruth': 'ruth', 'ru': 'ruth',
    '1samuel': '1-samuel', '1sam': '1-samuel', '1sm': '1-samuel', 'isamuel': '1-samuel', 'i samuel': '1-samuel', '1 samuel': '1-samuel',
    '2samuel': '2-samuel', '2sam': '2-samuel', '2sm': '2-samuel', 'iisamuel': '2-samuel', 'ii samuel': '2-samuel', '2 samuel': '2-samuel',
    '1kings': '1-kings', '1kgs': '1-kings', 'ikings': '1-kings', 'i kings': '1-kings', '1 kings': '1-kings', '3kings': '1-kings', '3 kings': '1-kings',
    '2kings': '2-kings', '2kgs': '2-kings', 'iikings': '2-kings', 'ii kings': '2-kings', '2 kings': '2-kings', '4kings': '2-kings', '4 kings': '2-kings',
    '1chronicles': '1-chronicles', '1chr': '1-chronicles', 'ichronicles': '1-chronicles', 'i chronicles': '1-chronicles', '1 chronicles': '1-chronicles', '1paralipomenon': '1-chronicles',
    '2chronicles': '2-chronicles', '2chr': '2-chronicles', 'iichronicles': '2-chronicles', 'ii chronicles': '2-chronicles', '2 chronicles': '2-chronicles', '2paralipomenon': '2-chronicles',
    'ezra': 'ezra', '1ezra': 'ezra', '1esdras': 'ezra', '1 esdras': 'ezra',
    'nehemiah': 'nehemiah', 'neh': 'nehemiah', '2ezra': 'nehemiah', '2esdras': 'nehemiah', '2 esdras': 'nehemiah',
    'tobias': 'tobias', 'tobit': 'tobias', 'tob': 'tobias',
    'judith': 'judith', 'jdt': 'judith', 'jdth': 'judith',
    'esther': 'esther', 'esth': 'esther', 'est': 'esther',
    // Wisdom
    'job': 'job', 'jb': 'job',
    'psalms': 'psalms', 'psalm': 'psalms', 'ps': 'psalms', 'pss': 'psalms',
    'proverbs': 'proverbs', 'prov': 'proverbs', 'prv': 'proverbs',
    'ecclesiastes': 'ecclesiastes', 'eccl': 'ecclesiastes', 'eccles': 'ecclesiastes', 'qoheleth': 'ecclesiastes', 'qoh': 'ecclesiastes',
    'canticles': 'canticles', 'canticle': 'canticles', 'song': 'canticles', 'songofsolomon': 'canticles', 'song of solomon': 'canticles', 'songofsongs': 'canticles', 'song of songs': 'canticles', 'sos': 'canticles', 'sg': 'canticles',
    'wisdom': 'wisdom', 'wis': 'wisdom', 'wisdomofsolomon': 'wisdom', 'wisdom of solomon': 'wisdom',
    'ecclesiasticus': 'ecclesiasticus', 'sirach': 'ecclesiasticus', 'sir': 'ecclesiasticus', 'ben sira': 'ecclesiasticus',
    // Prophets
    'isaias': 'isaias', 'isaiah': 'isaias', 'isa': 'isaias', 'is': 'isaias',
    'jeremias': 'jeremias', 'jeremiah': 'jeremias', 'jer': 'jeremias',
    'lamentations': 'lamentations', 'lam': 'lamentations',
    'baruch': 'baruch', 'bar': 'baruch',
    'ezechiel': 'ezechiel', 'ezekiel': 'ezechiel', 'ezek': 'ezechiel', 'ez': 'ezechiel',
    'daniel': 'daniel', 'dan': 'daniel', 'dn': 'daniel',
    'osee': 'osee', 'hosea': 'osee', 'hos': 'osee',
    'joel': 'joel', 'jl': 'joel',
    'amos': 'amos', 'am': 'amos',
    'abdias': 'abdias', 'obadiah': 'abdias', 'obad': 'abdias', 'ob': 'abdias',
    'jonas': 'jonas', 'jonah': 'jonas', 'jon': 'jonas',
    'micheas': 'micheas', 'micah': 'micheas', 'mic': 'micheas',
    'nahum': 'nahum', 'nah': 'nahum', 'na': 'nahum',
    'habacuc': 'habacuc', 'habakkuk': 'habacuc', 'hab': 'habacuc',
    'sophonias': 'sophonias', 'zephaniah': 'sophonias', 'zeph': 'sophonias',
    'aggeus': 'aggeus', 'haggai': 'aggeus', 'hag': 'aggeus', 'hg': 'aggeus',
    'zacharias': 'zacharias', 'zechariah': 'zacharias', 'zech': 'zacharias', 'zec': 'zacharias',
    'malachias': 'malachias', 'malachi': 'malachias', 'mal': 'malachias',
    '1machabees': '1-machabees', '1maccabees': '1-machabees', '1macc': '1-machabees', '1mac': '1-machabees', 'imachabees': '1-machabees', 'i machabees': '1-machabees', '1 machabees': '1-machabees', '1 maccabees': '1-machabees',
    '2machabees': '2-machabees', '2maccabees': '2-machabees', '2macc': '2-machabees', '2mac': '2-machabees', 'iimachabees': '2-machabees', 'ii machabees': '2-machabees', '2 machabees': '2-machabees', '2 maccabees': '2-machabees',
    // New Testament
    'matthew': 'matthew', 'matt': 'matthew', 'mt': 'matthew',
    'mark': 'mark', 'mk': 'mark',
    'luke': 'luke', 'lk': 'luke',
    'john': 'john', 'jn': 'john', 'jhn': 'john',
    'acts': 'acts', 'actsoftheapostles': 'acts', 'acts of the apostles': 'acts',
    'romans': 'romans', 'rom': 'romans', 'rm': 'romans',
    '1corinthians': '1-corinthians', '1cor': '1-corinthians', 'icorinthians': '1-corinthians', 'i corinthians': '1-corinthians', '1 corinthians': '1-corinthians',
    '2corinthians': '2-corinthians', '2cor': '2-corinthians', 'iicorinthians': '2-corinthians', 'ii corinthians': '2-corinthians', '2 corinthians': '2-corinthians',
    'galatians': 'galatians', 'gal': 'galatians',
    'ephesians': 'ephesians', 'eph': 'ephesians',
    'philippians': 'philippians', 'phil': 'philippians', 'php': 'philippians',
    'colossians': 'colossians', 'col': 'colossians',
    '1thessalonians': '1-thessalonians', '1thess': '1-thessalonians', '1thes': '1-thessalonians', 'ithessalonians': '1-thessalonians', 'i thessalonians': '1-thessalonians', '1 thessalonians': '1-thessalonians',
    '2thessalonians': '2-thessalonians', '2thess': '2-thessalonians', '2thes': '2-thessalonians', 'iithessalonians': '2-thessalonians', 'ii thessalonians': '2-thessalonians', '2 thessalonians': '2-thessalonians',
    '1timothy': '1-timothy', '1tim': '1-timothy', 'itimothy': '1-timothy', 'i timothy': '1-timothy', '1 timothy': '1-timothy',
    '2timothy': '2-timothy', '2tim': '2-timothy', 'iitimothy': '2-timothy', 'ii timothy': '2-timothy', '2 timothy': '2-timothy',
    'titus': 'titus', 'ti': 'titus',
    'philemon': 'philemon', 'phlm': 'philemon', 'phm': 'philemon',
    'hebrews': 'hebrews', 'heb': 'hebrews',
    'james': 'james', 'jas': 'james', 'jm': 'james',
    '1peter': '1-peter', '1pet': '1-peter', '1pt': '1-peter', 'ipeter': '1-peter', 'i peter': '1-peter', '1 peter': '1-peter',
    '2peter': '2-peter', '2pet': '2-peter', '2pt': '2-peter', 'iipeter': '2-peter', 'ii peter': '2-peter', '2 peter': '2-peter',
    '1john': '1-john', '1jn': '1-john', 'ijohn': '1-john', 'i john': '1-john', '1 john': '1-john',
    '2john': '2-john', '2jn': '2-john', 'iijohn': '2-john', 'ii john': '2-john', '2 john': '2-john',
    '3john': '3-john', '3jn': '3-john', 'iiijohn': '3-john', 'iii john': '3-john', '3 john': '3-john',
    'jude': 'jude', 'jud': 'jude',
    'apocalypse': 'apocalypse', 'revelation': 'apocalypse', 'rev': 'apocalypse', 'rv': 'apocalypse', 'apoc': 'apocalypse'
  };

  /**
   * Try to parse a verse reference from the query string.
   * Returns { bookId, chapter, verse } or null if not a verse reference.
   * Examples: "Sirach 3:21", "Gen 1:1", "1 John 3:16", "John 3:16-18"
   */
  function parseVerseReference(query: string): { bookId: string; chapter: number; verse: number } | null {
    // Normalize query
    const q = query.trim();

    // Pattern: optional number prefix, book name, chapter:verse (with optional range)
    // Examples: "Genesis 1:1", "1 John 3:16", "Sirach 3:21-23", "Gen 1:1"
    const match = q.match(/^(\d?\s*[a-z]+(?:\s+[a-z]+)?)\s*(\d+)\s*:\s*(\d+)(?:\s*-\s*\d+)?$/i);

    if (!match) return null;

    const [, bookPart, chapterStr, verseStr] = match;
    const chapter = parseInt(chapterStr, 10);
    const verse = parseInt(verseStr, 10);

    if (isNaN(chapter) || isNaN(verse)) return null;

    // Normalize book name: lowercase, remove spaces for lookup
    const bookNormalized = bookPart.toLowerCase().replace(/\s+/g, '');
    const bookId = bookMap[bookNormalized];

    // Also try with spaces preserved for multi-word names
    const bookWithSpaces = bookPart.toLowerCase().trim();
    const bookIdAlt = bookMap[bookWithSpaces];

    const finalBookId = bookId || bookIdAlt;

    if (!finalBookId) return null;

    return { bookId: finalBookId, chapter, verse };
  }

  async function loadSearchIndex(): Promise<void> {
    const statusEl = document.getElementById('search-status');
    if (statusEl) {
      statusEl.textContent = 'Loading search index';
      statusEl.classList.add('loading');
    }

    try {
      const response = await fetch(`${base}search-index.json`);
      if (!response.ok) throw new Error('Failed to load search index');

      searchIndex = await response.json();

      // Initialize Fuse.js
      fuse = new Fuse(searchIndex!.verses, {
        keys: [
          { name: 'text', weight: 1.0 },
          { name: 'footnotes', weight: 0.8 },
          { name: 'challoner', weight: 0.7 },
          { name: 'summary', weight: 0.6 }
        ],
        includeMatches: true,
        threshold: 0.3,
        minMatchCharLength: 3,
        ignoreLocation: true
      });

      if (statusEl) {
        statusEl.textContent = '';
        statusEl.classList.remove('loading');
      }

      // Check for query param
      const params = new URLSearchParams(window.location.search);
      const query = params.get('q');
      if (query) {
        const input = document.getElementById('search-input') as HTMLInputElement;
        if (input) {
          input.value = query;
          performSearch(query);
        }
      }
    } catch (error) {
      console.error('Failed to load search index:', error);
      if (statusEl) {
        statusEl.textContent = 'Failed to load search index. Please refresh the page.';
        statusEl.classList.remove('loading');
      }
    }
  }

  function getMatchType(matches: readonly Fuse.FuseResultMatch[] | undefined): { icon: string; label: string } {
    if (!matches || matches.length === 0) {
      return { icon: '', label: '' };
    }

    const key = matches[0].key;
    switch (key) {
      case 'text':
        return { icon: '', label: 'matched in verse text' };
      case 'footnotes':
        return { icon: '', label: 'matched in footnote' };
      case 'challoner':
        return { icon: '', label: 'matched in commentary' };
      case 'summary':
        return { icon: '', label: 'matched in chapter summary' };
      default:
        return { icon: '', label: '' };
    }
  }

  function highlightMatch(text: string, indices: readonly [number, number][] | undefined): string {
    if (!indices || indices.length === 0) return escapeHtml(text);

    // Sort indices by start position
    const sorted = [...indices].sort((a, b) => a[0] - b[0]);

    let result = '';
    let lastIndex = 0;

    for (const [start, end] of sorted) {
      // Add text before match
      result += escapeHtml(text.slice(lastIndex, start));
      // Add highlighted match
      result += `<mark>${escapeHtml(text.slice(start, end + 1))}</mark>`;
      lastIndex = end + 1;
    }

    // Add remaining text
    result += escapeHtml(text.slice(lastIndex));

    return result;
  }

  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function getSnippet(item: Verse, matches: readonly Fuse.FuseResultMatch[] | undefined): string {
    if (!matches || matches.length === 0) {
      // No matches found, show truncated verse text
      return item.text.length > 150 ? item.text.slice(0, 150) + '...' : item.text;
    }

    const match = matches[0];
    let text = '';

    // Get the matched text content
    if (match.key === 'text') {
      text = item.text;
    } else if (match.key === 'footnotes' && item.footnotes) {
      text = item.footnotes.join(' ');
    } else if (match.key === 'challoner' && item.challoner) {
      text = item.challoner.join(' ');
    } else if (match.key === 'summary' && item.summary) {
      text = item.summary;
    } else {
      text = item.text;
    }

    // Truncate if needed while preserving match context
    if (text.length > 200 && match.indices && match.indices.length > 0) {
      const firstMatch = match.indices[0][0];
      const start = Math.max(0, firstMatch - 50);
      const end = Math.min(text.length, firstMatch + 150);

      let snippet = text.slice(start, end);
      if (start > 0) snippet = '...' + snippet;
      if (end < text.length) snippet = snippet + '...';

      // Adjust indices for the truncated text
      const adjustedIndices = match.indices
        .filter(([s, e]) => s >= start && e <= end)
        .map(([s, e]) => [s - start + (start > 0 ? 3 : 0), e - start + (start > 0 ? 3 : 0)] as [number, number]);

      return highlightMatch(snippet, adjustedIndices);
    }

    return highlightMatch(text, match.indices);
  }

  function renderResults(results: Fuse.FuseResult<Verse>[]): void {
    const container = document.getElementById('search-results');
    if (!container) return;

    if (results.length === 0) {
      container.innerHTML = `
        <div class="no-results">
          <h2>No results found</h2>
          <p>Try different keywords or check your spelling.</p>
        </div>
      `;
      return;
    }

    // Limit to 50 results
    const limited = results.slice(0, 50);

    container.innerHTML = limited.map(result => {
      const item = result.item;
      const matchType = getMatchType(result.matches);
      const snippet = getSnippet(item, result.matches);
      const url = `${base}${item.book}/${item.chapter}/#v${item.verse}`;

      return `
        <a href="${url}" class="search-result">
          <div class="ref">${escapeHtml(item.ref)}</div>
          <div class="snippet">${snippet}</div>
          ${matchType.label ? `<div class="match-type">${matchType.label}</div>` : ''}
        </a>
      `;
    }).join('');
  }

  function performSearch(query: string, navigateOnVerseRef: boolean = true): void {
    const statusEl = document.getElementById('search-status');
    const container = document.getElementById('search-results');

    if (!query.trim()) {
      if (statusEl) statusEl.textContent = '';
      if (container) container.innerHTML = '';
      // Clear URL param
      const url = new URL(window.location.href);
      url.searchParams.delete('q');
      window.history.replaceState({}, '', url.toString());
      return;
    }

    // Check if query is a verse reference (e.g., "Sirach 3:21")
    const verseRef = parseVerseReference(query);
    if (verseRef && navigateOnVerseRef) {
      const verseUrl = `${base}${verseRef.bookId}/${verseRef.chapter}/#v${verseRef.verse}`;
      if (statusEl) statusEl.textContent = `Navigating to ${query}...`;
      window.location.href = verseUrl;
      return;
    }

    if (!fuse) {
      if (statusEl) statusEl.textContent = 'Search index not loaded yet...';
      return;
    }

    const results = fuse.search(query);

    if (statusEl) {
      statusEl.textContent = results.length === 0
        ? `No results for "${query}"`
        : `Found ${results.length} result${results.length === 1 ? '' : 's'} for "${query}"`;
    }

    // Update URL param
    const url = new URL(window.location.href);
    url.searchParams.set('q', query);
    window.history.replaceState({}, '', url.toString());

    renderResults(results);
  }

  function setupSearch(): void {
    const input = document.getElementById('search-input') as HTMLInputElement;
    if (!input) return;

    input.addEventListener('input', () => {
      if (debounceTimer) {
        clearTimeout(debounceTimer);
      }

      debounceTimer = window.setTimeout(() => {
        performSearch(input.value);
      }, 300);
    });

    // Handle form submission (Enter key)
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (debounceTimer) {
          clearTimeout(debounceTimer);
        }
        performSearch(input.value);
      }
    });
  }

  // Initialize on page load
  document.addEventListener('astro:page-load', () => {
    loadSearchIndex();
    setupSearch();
  });
</script>
